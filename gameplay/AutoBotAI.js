/**
 * è‡ªåŠ¨æœºå™¨äººAI
 * ä¸“é—¨ç”¨äºGitHub Actionå’ŒCLè‡ªåŠ¨æœºå™¨äºº
 * æ¯å›åˆè‡ªåŠ¨æ‰§è¡ŒgitåŸå­æ“ä½œ
 */
class AutoBotAI {
    constructor(gameState, cardFactory, player, botType, gitOperations = null) {
        this.gameState = gameState;
        this.cardFactory = cardFactory;
        this.player = player;
        this.botType = botType; // 'github-action' æˆ– 'cl-bot'
        // ä½¿ç”¨ä¼ å…¥çš„æ“ä½œåˆ—è¡¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤åˆ—è¡¨
        this.gitOperations = gitOperations || [
            'add', 'commit', 'push', 'pull', 'fetch',
            'branch', 'checkout', 'merge', 'status', 'log'
        ];
    }
    
    /**
     * ä»å…è®¸çš„æ“ä½œåˆ—è¡¨ä¸­è·å–éšæœºå¡ç‰Œ
     */
    getRandomCardFromOperations() {
        if (!this.gitOperations || this.gitOperations.length === 0) {
            return this.cardFactory.getRandomCard();
        }
        
        // ä»CARD_DATAä¸­æ‰¾åˆ°åŒ¹é…çš„æ“ä½œï¼ˆCARD_DATAæ˜¯å…¨å±€å˜é‡ï¼‰
        if (typeof CARD_DATA === 'undefined') {
            return this.cardFactory.getRandomCard();
        }
        
        const availableCards = CARD_DATA.filter(card => 
            this.gitOperations.includes(card.id)
        );
        
        if (availableCards.length === 0) {
            return this.cardFactory.getRandomCard();
        }
        
        // éšæœºé€‰æ‹©ä¸€ä¸ªæ“ä½œ
        const randomIndex = Math.floor(Math.random() * availableCards.length);
        const cardData = availableCards[randomIndex];
        
        return this.cardFactory.createCard(cardData);
    }

    /**
     * æ‰§è¡Œè‡ªåŠ¨å›åˆï¼ˆæ¯å›åˆå¼€å§‹æ—¶è°ƒç”¨ï¼‰
     * ç®€åŒ–é€»è¾‘ï¼šç›´æ¥æŠ½å–ä¸€å¼ ç‰Œå¹¶æ‰“å‡º
     * @param {Function} logCallback - æ—¥å¿—å›è°ƒå‡½æ•°
     */
    executeTurn(logCallback = null) {
        if (this.player.health <= 0) {
            return;
        }

        // ç›´æ¥ä»å…è®¸çš„æ“ä½œåˆ—è¡¨ä¸­æŠ½å–ä¸€å¼ ç‰Œ
        const card = this.getRandomCardFromOperations();
        if (!card) {
            if (logCallback) {
                const botName = this.botType === 'github-action' ? 'GitHub Action' : 'CLè‡ªåŠ¨æœºå™¨äºº';
                logCallback(`ğŸ¤– ${botName} æ— æ³•è·å–å¡ç‰Œï¼Œè·³è¿‡å›åˆ`, this.player.name);
            }
            return;
        }

        // æ£€æŸ¥å¡ç‰Œæ˜¯å¦æœ‰æ•ˆæœç»„ä»¶
        if (!card.effectComponent) {
            if (logCallback) {
                const botName = this.botType === 'github-action' ? 'GitHub Action' : 'CLè‡ªåŠ¨æœºå™¨äºº';
                logCallback(`ğŸ¤– ${botName} çš„å¡ç‰Œ ${card.name} æ²¡æœ‰æ•ˆæœï¼Œè·³è¿‡`, this.player.name);
            }
            return;
        }

        // ç¡®å®šç›®æ ‡
        const target = card.type === 'heal' 
            ? this.player.name 
            : this.selectTarget();

        // æ¶ˆè€—èƒ½é‡ï¼ˆè™½ç„¶èƒ½é‡æ˜¯999ï¼Œä½†ä¸ºäº†ä¿æŒä¸€è‡´æ€§ï¼‰
        this.player.consumeMana(card.cost);

        // æ‰§è¡Œå¡ç‰Œæ•ˆæœ
        const cardEffect = new CardEffect(this.gameState, null, this.cardFactory);
        const result = cardEffect.execute(card, target, this.player.name);

        // è®°å½•å¡ç‰Œæ‰“å‡ºå†å²
        if (this.gameState.recordCardPlay) {
            this.gameState.recordCardPlay(card, this.player.name, this.gameState.turnNumber);
        }

        // æ˜¾ç¤ºæ‰“å‡ºçš„å¡ç‰Œ
        if (this.gameState.cardAnimation && this.gameState.cardRenderer) {
            this.gameState.cardAnimation.showPlayedCardDirectly(
                card,
                this.player.name,
                this.gameState.cardRenderer,
                this.gameState.currentTurnCards
            );
        }

        // è§¦å‘äº‹ä»¶
        if (this.gameState.eventSystem) {
            this.gameState.eventSystem.emit('card:played', {
                card: {
                    id: card.id,
                    baseId: card.baseId,
                    name: card.name,
                    icon: card.icon,
                    cost: card.cost,
                    power: card.power || 0,
                    heal: card.heal || 0,
                    draw: card.draw || 0,
                    type: card.type,
                    isAutoGenerated: true,
                    isFromBuff: true,
                    isFromAutoBot: true
                },
                player: this.player.name,
                target: target
            });
            this.gameState.eventSystem.emit('gitgraph:update');
        }

        // è®°å½•æ—¥å¿—
        if (logCallback) {
            const botName = this.botType === 'github-action' ? 'GitHub Action' : 'CLè‡ªåŠ¨æœºå™¨äºº';
            logCallback(`ğŸ¤– ${botName} è‡ªåŠ¨æ‰§è¡Œäº† ${card.icon} ${card.name}ï¼`, this.player.name);
        }
    }

    /**
     * é€‰æ‹©ç›®æ ‡ï¼ˆé€‰æ‹©æ•Œå¯¹ç©å®¶ï¼‰
     */
    selectTarget() {
        const enemies = this.gameState.getEnemyPlayers();
        if (enemies.length === 0) {
            return this.player.name; // æ²¡æœ‰æ•Œäººï¼Œå¯¹è‡ªå·±ä½¿ç”¨
        }
        // éšæœºé€‰æ‹©ä¸€ä¸ªæ•Œäºº
        return enemies[Math.floor(Math.random() * enemies.length)].name;
    }
}

