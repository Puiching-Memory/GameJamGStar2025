/**
 * Âç°ÁâåÊïàÊûúÂ§ÑÁêÜÂô®
 * Ë¥üË¥£ÊâßË°åÂç°ÁâåÊïàÊûúÂπ∂Â§ÑÁêÜÁõ∏ÂÖ≥ÈÄªËæë
 * ‰ΩøÁî®ÊïàÊûúÁªÑ‰ª∂Á≥ªÁªü
 */
class CardEffect {
    constructor(gameState, logSystem, cardFactory = null) {
        this.gameState = gameState;
        this.logSystem = logSystem;
        this.cardFactory = cardFactory;
    }

    /**
     * Ê†ºÂºèÂåñÂç°ÁâåËØ¶ÁªÜ‰ø°ÊÅØ
     * @param {Card} card - Âç°ÁâåÂÆû‰æã
     * @returns {string} Ê†ºÂºèÂåñÂêéÁöÑÂç°Áâå‰ø°ÊÅØÂ≠óÁ¨¶‰∏≤
     */
    formatCardDetails(card) {
        const parts = [];
        
        // Âç°ÁâåÂêçÁß∞ÂíåÂõæÊ†á
        parts.push(`${card.icon} ${card.name}`);
        
        // Ë¥πÁî®
        parts.push(`üíé${card.cost}`);
        
        // Êï∞ÂÄºÊïàÊûúÔºàÂ¶ÇÊûúÊúâÔºâ
        const effects = [];
        if (card.power > 0) {
            effects.push(`‚öîÔ∏è${card.power}`);
        }
        if (card.heal > 0) {
            effects.push(`üíö${card.heal}`);
        }
        if (card.draw > 0) {
            effects.push(`üìö${card.draw}`);
        }
        if (effects.length > 0) {
            parts.push(effects.join(' '));
        }
        
        // Á±ªÂûãÔºàÂ¶ÇÊûúÊúâÁâπÊÆäÁ±ªÂûãÔºâ
        if (card.type && card.type !== 'attack') {
            const typeMap = {
                'heal': 'üíöÊ≤ªÁñó',
                'special': '‚ú®ÁâπÊÆä',
                'buff': 'üõ°Ô∏èÂ¢ûÁõä'
            };
            parts.push(typeMap[card.type] || card.type);
        }
        
        return parts.join(' | ');
    }

    /**
     * ÊâßË°åÂç°ÁâåÊïàÊûú
     */
    execute(card, target, cardUser) {
        if (!card.effectComponent) {
            console.warn(`Âç°Áâå ${card.name} Ê≤°ÊúâÊïàÊûúÁªÑ‰ª∂`);
            return null;
        }

        const context = {
            gameState: this.gameState,
            target: target,
            cardUser: cardUser,
            card: card,
            cardFactory: this.cardFactory
        };

        // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÊâßË°å
        if (!card.effectComponent.canExecute(context)) {
            return null;
        }

        try {
            // ËÆ∞ÂΩïÂç°ÁâåËØ¶ÁªÜ‰ø°ÊÅØÔºàÂè™ËÆ∞ÂΩïÂà∞ÂºÄÂèëËÄÖÊó•ÂøóÔºå‰∏çÊòæÁ§∫Âú®ÂºπÂπïÔºâ
            if (this.logSystem) {
                const cardDetails = this.formatCardDetails(card);
                this.logSystem.addLog({
                    userMessage: '', // ‰∏çÊòæÁ§∫Âú®ÂºπÂπï
                    devMessage: `[CardPlay] ${cardUser} ÊâìÂá∫Âç°Áâå: ${cardDetails} | Target: ${target} | Mana: ${this.gameState.getCurrentPlayer().mana}/${this.gameState.getCurrentPlayer().maxMana}`
                }, cardUser);
            }

            // ÊâßË°åÊïàÊûú
            const result = card.effectComponent.execute(context);
            
            // Ëß¶ÂèëÂç°Áâå‰ΩøÁî®‰∫ã‰ª∂ÔºàÂè™ÂèëÈÄÅÂøÖË¶ÅÁöÑÊï∞ÊçÆÔºåÈÅøÂÖçÂæ™ÁéØÂºïÁî®Ôºâ
            if (this.gameState.eventSystem) {
                this.gameState.eventSystem.emit('card:played', {
                    card: {
                        id: card.id,
                        name: card.name,
                        icon: card.icon,
                        cost: card.cost,
                        power: card.power || 0,
                        heal: card.heal || 0,
                        draw: card.draw || 0,
                        type: card.type,
                        isAutoGenerated: card.isAutoGenerated || false,
                        isFromBuff: card.isFromBuff || false,
                        isFromAutoBot: card.isFromAutoBot || false
                    },
                    player: cardUser,
                    target: target
                });
            }

            // ËÆ∞ÂΩïÊïàÊûúÊó•Âøó
            if (result && result.message && this.logSystem) {
                const source = result.source || cardUser;
                // Â¶ÇÊûúresult‰∏≠ÊúâuserMessageÂíådevMessageÔºå‰ΩøÁî®ÂÆÉ‰ª¨ÔºõÂê¶Âàô‰ΩøÁî®message
                if (result.userMessage !== undefined || result.devMessage !== undefined) {
                    this.logSystem.addLog({
                        userMessage: result.userMessage || '',
                        devMessage: result.devMessage || result.message
                    }, source);
                } else {
                    // ÂêëÂêéÂÖºÂÆπÔºöÂè™Êèê‰æõ‰∫Ümessage
                    this.logSystem.addLog({
                        userMessage: '', // ‰∏çÊòæÁ§∫Âú®ÂºπÂπï
                        devMessage: `[CardEffect] ${result.message} | Source: ${source} | Card: ${card.name}`
                    }, source);
                }
            }

            return result;
        } catch (error) {
            console.error(`ÊâßË°åÂç°Áâå ${card.name} ÁöÑÊïàÊûúÊó∂ÂèëÁîüÈîôËØØ:`, error);
            if (this.logSystem) {
                this.logSystem.addLog({
                    userMessage: `Âç°Áâå ${card.name} ÊïàÊûúÊâßË°åÂ§±Ë¥•ÔºÅ`,
                    devMessage: `[Error] Âç°ÁâåÊïàÊûúÊâßË°åÂ§±Ë¥• | Card: ${card.name} | User: ${cardUser} | Target: ${target} | Error: ${error.message || error.toString()}`
                }, 'system');
            }
            return null;
        }
    }

    /**
     * Á°ÆÂÆöÂç°ÁâåÁõÆÊ†á
     * @param {Card} card - Âç°Áâå
     * @param {string} cardUser - Âá∫ÁâåËÄÖ ('player' Êàñ 'opponent')
     */
    determineTarget(card, cardUser) {
        // Ê≤ªÁñóÁâåÊÄªÊòØÂØπËá™Â∑±‰ΩøÁî®
        if (card.type === 'heal') {
            return cardUser;
        }
        
        // ÊîªÂáªÁâåÔºö‰ªéÊïåÂØπÁé©ÂÆ∂‰∏≠ÈÄâÊã©ÔºàÊéíÈô§Ëá™Âä®Êú∫Âô®‰∫∫Ôºâ
        const enemyPlayers = this.gameState.getEnemyPlayers();
        if (enemyPlayers.length > 0) {
            // ‰ºòÂÖàÈÄâÊã©Áé©ÂÆ∂ÊàñÂØπÊâãÔºàÈùûËá™Âä®Êú∫Âô®‰∫∫Ôºâ
            const mainEnemy = enemyPlayers.find(p => p.name === 'player' || p.name === 'opponent');
            if (mainEnemy) {
                return mainEnemy.name;
            }
            // Â¶ÇÊûúÊ≤°Êúâ‰∏ªË¶ÅÂØπÊâãÔºåËøîÂõûÁ¨¨‰∏Ä‰∏™ÊïåÂØπÁé©ÂÆ∂ÔºàËôΩÁÑ∂ÁêÜËÆ∫‰∏ä‰∏çÂ∫îËØ•ÊúâËøôÁßçÊÉÖÂÜµÔºâ
            return enemyPlayers[0].name;
        }
        
        // Â¶ÇÊûúÊ≤°ÊúâÊïåÂØπÁé©ÂÆ∂ÔºåËøîÂõûÈªòËÆ§ÂØπÊâãÔºàÂêëÂêéÂÖºÂÆπÔºâ
        return cardUser === 'player' ? 'opponent' : 'player';
    }

    /**
     * Â§ÑÁêÜËøûÂáªbuffÔºàÂêàÂπ∂Ëá™ ComboBuffHandlerÔºâ
     * @param {string} playerName - Áé©ÂÆ∂ÂêçÁß∞ ('player' Êàñ 'opponent')
     */
    processComboBuff(playerName) {
        const player = playerName === 'player' ? this.gameState.player : this.gameState.opponent;
        const opponent = playerName === 'player' ? this.gameState.opponent : this.gameState.player;
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâËøûÂáªbuff
        const comboBuffs = player.getBuffsByType('special').filter(buff => 
            buff.name === 'ËøûÂáª' || buff.description.includes('È¢ùÂ§ñ‰º§ÂÆ≥')
        );
        
        if (comboBuffs.length > 0) {
            comboBuffs.forEach(buff => {
                // Ê£ÄÊü•buffÊòØÂê¶ÊúâËøûÂáªÊïàÊûúÔºàÈÄöËøávalueÂà§Êñ≠Ôºâ
                if (buff.value > 0) {
                    const damage = player.calculateAttackDamage(buff.value);
                    const actualDamage = opponent.takeDamage(damage, this.gameState.eventSystem);
                    
                    if (actualDamage > 0 && this.logSystem) {
                        const source = playerName === 'player' ? 'player' : 'opponent';
                        this.logSystem.addLog({
                            userMessage: '', // ‰∏çÊòæÁ§∫Âú®ÂºπÂπï
                            devMessage: `[ComboBuff] ${buff.name} Ëß¶Âèë | Player: ${playerName} | Buff Value: ${buff.value} | Calculated Damage: ${damage} | Actual Damage: ${actualDamage} | Target Health: ${opponent.health}/${opponent.maxHealth}`
                        }, source);
                    }
                }
            });
        }
    }
}

